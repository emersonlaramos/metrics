Boa, bora transformar aqueles insights em queries PromQL que vocÃª pode usar direto no Grafana com azure_devops_stats_agentpool_builds_duration e outras mÃ©tricas de stats.
Vou montar exemplos usando funÃ§Ãµes tÃ­picas (avg_over_time, histogram_quantile, increase, etc.).


---

ğŸ” Queries PromQL para Grafana

1. Gargalos: execuÃ§Ã£o vs espera

# ExecuÃ§Ã£o mÃ©dia (Ãºltimos 30m)
avg_over_time(azure_devops_stats_agentpool_builds_duration_seconds_sum[30m])
  / avg_over_time(azure_devops_stats_agentpool_builds_duration_seconds_count[30m])

# Espera mÃ©dia (Ãºltimos 30m)
avg_over_time(azure_devops_stats_agentpool_builds_wait_seconds_sum[30m])
  / avg_over_time(azure_devops_stats_agentpool_builds_wait_seconds_count[30m])

> Se a espera for maior que execuÃ§Ã£o â†’ falta capacidade nos pools.




---

2. EficiÃªncia por agent pool

# DuraÃ§Ã£o mÃ©dia por pool
(
  sum by (agentpool) (rate(azure_devops_stats_agentpool_builds_duration_seconds_sum[1h]))
  /
  sum by (agentpool) (rate(azure_devops_stats_agentpool_builds_duration_seconds_count[1h]))
)

> Mostra quais pools tÃªm builds mais lentos â†’ candidatos a otimizaÃ§Ã£o ou redistribuiÃ§Ã£o.




---

3. RegressÃµes em pipelines

# P95 de duraÃ§Ã£o (Ãºltima hora) â€“ comparÃ¡vel com perÃ­odos passados
histogram_quantile(0.95,
  sum by (le, project) (rate(azure_devops_stats_agentpool_builds_duration_seconds_bucket[1h]))
)

> Se subir em relaÃ§Ã£o Ã  semana passada â†’ regressÃ£o.




---

4. Alerta de builds anormalmente longos

# Percentil 95 acima de 30 minutos nos Ãºltimos 15m
histogram_quantile(0.95,
  sum by (le, agentpool) (rate(azure_devops_stats_agentpool_builds_duration_seconds_bucket[15m]))
) > 1800

> Configurar no Prometheus Alertmanager para disparar alerta.




---

5. ComparaÃ§Ã£o entre projetos

# MÃ©dia de duraÃ§Ã£o por projeto (Ãºltimos 30m)
(
  sum by (project) (rate(azure_devops_stats_agentpool_builds_duration_seconds_sum[30m]))
  /
  sum by (project) (rate(azure_devops_stats_agentpool_builds_duration_seconds_count[30m]))
)

> Ranking de projetos mais rÃ¡pidos/lentos no Grafana.




---

6. Impacto de incidentes

# TendÃªncia de aumento de duraÃ§Ã£o em todos pools (Ãºltimos 6h)
avg_over_time(
  (
    sum by (agentpool) (rate(azure_devops_stats_agentpool_builds_duration_seconds_sum[5m]))
    /
    sum by (agentpool) (rate(azure_devops_stats_agentpool_builds_duration_seconds_count[5m]))
  )[6h:]
)

> DÃ¡ para usar em grÃ¡fico de linha para ver picos em incidentes.




---

7. Estimativa de custo (tempo total consumido)

# Total de horas de build por projeto no Ãºltimo dia
sum by (project) (increase(azure_devops_stats_agentpool_builds_duration_seconds_sum[1d])) / 3600

> Se vocÃª paga por uso de agentes, vira um indicador direto de custo.




---

8. Capacity planning

# Quantidade de builds executados por pool nas Ãºltimas 24h
sum by (agentpool) (increase(azure_devops_stats_agentpool_builds_duration_seconds_count[24h]))

# Tempo total gasto em builds por pool nas Ãºltimas 24h
sum by (agentpool) (increase(azure_devops_stats_agentpool_builds_duration_seconds_sum[24h])) / 3600

> DÃ¡ para comparar demanda (builds/dia) vs capacidade atual (horas de agente/dia).




---

ğŸ‘‰ Essas queries jÃ¡ podem ser plugadas em painÃ©is Grafana (mÃ©dia, percentis, ranking por projeto/pool) e em alertas Prometheus.

Quer que eu monte um painel exemplo do Grafana (JSON) jÃ¡ com esses grÃ¡ficos prontos pra vocÃª importar direto?

