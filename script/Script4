#!/bin/bash
set -x # Mantendo o debug por enquanto

# DiretÃ³rios a serem verificados (adapte para seus testes)
K8S_PATHS=("k8s/dev" "k8s/hml" "k8s/prd")

compliant_count=0
non_compliant_count=0
error_details=""

declare -a checks=(
  "all(.spec.template.spec.containers[]; .securityContext != null);O bloco securityContext Ã© obrigatÃ³rio"
  "all(.spec.template.spec.containers[]; .securityContext.privileged == false);Containers privilegiados nÃ£o sÃ£o permitidos"
  "all(.spec.template.spec.containers[]; .securityContext.allowPrivilegeEscalation == false);EscalaÃ§Ã£o de privilÃ©gio nÃ£o Ã© permitida"
  "all(.spec.template.spec.containers[]; .securityContext.runAsNonRoot == true);Containers devem rodar como non-root"
  "all(.spec.template.spec.containers[]; .resources.limits.cpu != null);Containers devem ter limites de CPU definidos"
  "all(.spec.template.spec.containers[]; .resources.limits.memory != null);Containers devem ter limites de memÃ³ria definidos"
)

for d in "${K8S_PATHS[@]}"; do
  echo "--> Verificando diretÃ³rio: $d"
  find "$d" -type f \( -name "*.yaml" -o -name "*.yml" \) | while read -r manifest; do
    if [ ! -f "$manifest" ]; then continue; fi
    echo "    Validando arquivo: $manifest"

    for rule in "${checks[@]}"; do
      # ======================= A GRANDE MUDANÃ‡A ESTÃ AQUI =======================
      # SubstituÃ­mos o 'read' por um mÃ©todo de divisÃ£o de string mais robusto.
      yq_expression="${rule%%;*}"  # Pega tudo ANTES do primeiro ';'
      error_message="${rule#*;}"   # Pega tudo DEPOIS do primeiro ';'
      # ========================================================================

      result=$(yq eval "$yq_expression" "$manifest" 2>/dev/null || echo "error")

      if [[ "$result" == "true" ]]; then
        ((compliant_count++))
      else
        ((non_compliant_count++))
        error_details+="[FALHA] Arquivo: $manifest\n        Regra: $error_message\n"
      fi
    done
  done
done

set +x

# --- Report Final ---
echo "================================================"
echo "              Report da ValidaÃ§Ã£o"
echo "================================================"
echo "VerificaÃ§Ãµes em conformidade: $compliant_count"
echo "VerificaÃ§Ãµes fora de conformidade: $non_compliant_count"
echo "------------------------------------------------"

if [ $non_compliant_count -gt 0 ]; then
  echo -e "\nðŸ”´ ENCONTRADOS PROBLEMAS DE CONFORMIDADE:\n"
  echo -e "$error_details"
  exit 1
else
  echo -e "\nðŸŸ¢ Todos os manifestos estÃ£o em conformidade!\n"
fi
